#include "client.h"

#include <stdint.h>
#include <stdlib.h>
#include <avr/pgmspace.h>
#include <avr/interrupt.h>

#include "uart.h"
#include "spi.h"

volatile uint8_t data = 0;

#define N_SPRITES 128
typedef struct {
    int16_t x, y;
    int8_t  dir_x, dir_y;
} Sprite;

int main(void)
{
    srand(0);

    c_init(C_SPI);
    sei();

    // initialize graphics mode and clear screen
    c_print_P(PSTR("\e*1g\e[1;1H\e[2J"));

    // setup bitmaps
    c_print_P(PSTR("\e*$39,0;$5,31;$9,0;$9,31;$6,0;$11,31;$5,0;$11,31;$4,0;$4,31;0;0;31;0;0;$4,31;$3,0;$4,31;0;0;31;0;0;$4,31;$3,0;$13,31;$3,0;$3,31;0;$5,31;0;$3,31;$3,0;$3,31;0;$5,31;0;$3,31;$4,0;$3,31;$5,0;$3,31;$5,0;$11,31;$6,0;$9,31;$9,0;$5,31;$22,0i"));
    c_print_P(PSTR("\e*1;$38,0;$5,6;$9,0;$9,6;$6,0;$11,6;$5,0;$11,6;$4,0;$4,6;0;0;6;0;0;$4,6;$3,0;$4,6;0;0;6;0;0;$4,6;$3,0;$13,6;$3,0;$3,6;0;$5,6;0;$3,6;$3,0;$3,6;0;$5,6;0;$3,6;$4,0;$3,6;$5,0;$3,6;$5,0;$11,6;$6,0;$9,6;$9,0;$5,6;$22,0i"));
    /*
    c_print_P(PSTR("\e*2;$38,0;$5,7;$9,0;$9,7;$6,0;$11,7;$5,0;$11,7;$4,0;$4,7;0;0;7;0;0;$4,7;$3,0;$4,7;0;0;7;0;0;$4,7;$3,0;$13,7;$3,0;$3,7;0;$5,7;0;$3,7;$3,0;$3,7;0;$5,7;0;$3,7;$4,0;$3,7;$5,0;$3,7;$5,0;$11,7;$6,0;$9,7;$9,0;$5,7;$22,0i"));
    c_print_P(PSTR("\e*3;$38,0;$5,8;$9,0;$9,8;$6,0;$11,8;$5,0;$11,8;$4,0;$4,8;0;0;8;0;0;$4,8;$3,0;$4,8;0;0;8;0;0;$4,8;$3,0;$13,8;$3,0;$3,8;0;$5,8;0;$3,8;$3,0;$3,8;0;$5,8;0;$3,8;$4,0;$3,8;$5,0;$3,8;$5,0;$11,8;$6,0;$9,8;$9,0;$5,8;$22,0i"));
    c_print_P(PSTR("\e*4;$38,0;$5,9;$9,0;$9,9;$6,0;$11,9;$5,0;$11,9;$4,0;$4,9;0;0;9;0;0;$4,9;$3,0;$4,9;0;0;9;0;0;$4,9;$3,0;$13,9;$3,0;$3,9;0;$5,9;0;$3,9;$3,0;$3,9;0;$5,9;0;$3,9;$4,0;$3,9;$5,0;$3,9;$5,0;$11,9;$6,0;$9,9;$9,0;$5,9;$22,0i"));
    c_print_P(PSTR("\e*5;$38,0;$5,10;$9,0;$9,10;$6,0;$11,10;$5,0;$11,10;$4,0;$4,10;0;0;10;0;0;$4,10;$3,0;$4,10;0;0;10;0;0;$4,10;$3,0;$13,10;$3,0;$3,10;0;$5,10;0;$3,10;$3,0;$3,10;0;$5,10;0;$3,10;$4,0;$3,10;$5,0;$3,10;$5,0;$11,10;$6,0;$9,10;$9,0;$5,10;$22,0i"));
    c_print_P(PSTR("\e*6;$38,0;$5,11;$9,0;$9,11;$6,0;$11,11;$5,0;$11,11;$4,0;$4,11;0;0;11;0;0;$4,11;$3,0;$4,11;0;0;11;0;0;$4,11;$3,0;$13,11;$3,0;$3,11;0;$5,11;0;$3,11;$3,0;$3,11;0;$5,11;0;$3,11;$4,0;$3,11;$5,0;$3,11;$5,0;$11,11;$6,0;$9,11;$9,0;$5,11;$22,0i"));
    c_print_P(PSTR("\e*7;$38,0;$5,12;$9,0;$9,12;$6,0;$11,12;$5,0;$11,12;$4,0;$4,12;0;0;12;0;0;$4,12;$3,0;$4,12;0;0;12;0;0;$4,12;$3,0;$13,12;$3,0;$3,12;0;$5,12;0;$3,12;$3,0;$3,12;0;$5,12;0;$3,12;$4,0;$3,12;$5,0;$3,12;$5,0;$11,12;$6,0;$9,12;$9,0;$5,12;$22,0i"));
    c_print_P(PSTR("\e*8;$38,0;$5,19;$9,0;$9,19;$6,0;$11,19;$5,0;$11,19;$4,0;$4,19;0;0;19;0;0;$4,19;$3,0;$4,19;0;0;19;0;0;$4,19;$3,0;$13,19;$3,0;$3,19;0;$5,19;0;$3,19;$3,0;$3,19;0;$5,19;0;$3,19;$4,0;$3,19;$5,0;$3,19;$5,0;$11,19;$6,0;$9,19;$9,0;$5,19;$22,0i"));
    c_print_P(PSTR("\e*9;$38,0;$5,20;$9,0;$9,20;$6,0;$11,20;$5,0;$11,20;$4,0;$4,20;0;0;20;0;0;$4,20;$3,0;$4,20;0;0;20;0;0;$4,20;$3,0;$13,20;$3,0;$3,20;0;$5,20;0;$3,20;$3,0;$3,20;0;$5,20;0;$3,20;$4,0;$3,20;$5,0;$3,20;$5,0;$11,20;$6,0;$9,20;$9,0;$5,20;$22,0i"));
    c_print_P(PSTR("\e*10;$38,0;$5,21;$9,0;$9,21;$6,0;$11,21;$5,0;$11,21;$4,0;$4,21;0;0;21;0;0;$4,21;$3,0;$4,21;0;0;21;0;0;$4,21;$3,0;$13,21;$3,0;$3,21;0;$5,21;0;$3,21;$3,0;$3,21;0;$5,21;0;$3,21;$4,0;$3,21;$5,0;$3,21;$5,0;$11,21;$6,0;$9,21;$9,0;$5,21;$22,0i"));
    c_print_P(PSTR("\e*11;$38,0;$5,22;$9,0;$9,22;$6,0;$11,22;$5,0;$11,22;$4,0;$4,22;0;0;22;0;0;$4,22;$3,0;$4,22;0;0;22;0;0;$4,22;$3,0;$13,22;$3,0;$3,22;0;$5,22;0;$3,22;$3,0;$3,22;0;$5,22;0;$3,22;$4,0;$3,22;$5,0;$3,22;$5,0;$11,22;$6,0;$9,22;$9,0;$5,22;$22,0i"));
    c_print_P(PSTR("\e*12;$38,0;$5,23;$9,0;$9,23;$6,0;$11,23;$5,0;$11,23;$4,0;$4,23;0;0;23;0;0;$4,23;$3,0;$4,23;0;0;23;0;0;$4,23;$3,0;$13,23;$3,0;$3,23;0;$5,23;0;$3,23;$3,0;$3,23;0;$5,23;0;$3,23;$4,0;$3,23;$5,0;$3,23;$5,0;$11,23;$6,0;$9,23;$9,0;$5,23;$22,0i"));
    c_print_P(PSTR("\e*13;$38,0;$5,29;$9,0;$9,29;$6,0;$11,29;$5,0;$11,29;$4,0;$4,29;0;0;29;0;0;$4,29;$3,0;$4,29;0;0;29;0;0;$4,29;$3,0;$13,29;$3,0;$3,29;0;$5,29;0;$3,29;$3,0;$3,29;0;$5,29;0;$3,29;$4,0;$3,29;$5,0;$3,29;$5,0;$11,29;$6,0;$9,29;$9,0;$5,29;$22,0i"));
    c_print_P(PSTR("\e*14;$38,0;$5,31;$9,0;$9,31;$6,0;$11,31;$5,0;$11,31;$4,0;$4,31;0;0;31;0;0;$4,31;$3,0;$4,31;0;0;31;0;0;$4,31;$3,0;$13,31;$3,0;$3,31;0;$5,31;0;$3,31;$3,0;$3,31;0;$5,31;0;$3,31;$4,0;$3,31;$5,0;$3,31;$5,0;$11,31;$6,0;$9,31;$9,0;$5,31;$22,0i"));
    c_print_P(PSTR("\e*15;$38,0;$5,15;$9,0;$9,15;$6,0;$11,15;$5,0;$11,15;$4,0;$4,15;0;0;15;0;0;$4,15;$3,0;$4,15;0;0;15;0;0;$4,15;$3,0;$13,15;$3,0;$3,15;0;$5,15;0;$3,15;$3,0;$3,15;0;$5,15;0;$3,15;$4,0;$3,15;$5,0;$3,15;$5,0;$11,15;$6,0;$9,15;$9,0;$5,15;$22,0i"));

    Sprite sprites[N_SPRITES];
    for (size_t i = 0; i < N_SPRITES; ++i) {
        sprites[i].x = rand() % (256-16);
        sprites[i].y = rand() % (256-16);
        sprites[i].dir_x = (rand() % 8) - 4;
        sprites[i].dir_y = (rand() % 8) - 4;
        c_printf_P(PSTR("\e*%d;%d;%d;1;0;0;0;%dS"), i, sprites[i].x, sprites[i].y, i % 16);
    }

    // start receiving VSYNCs
    c_print_P(PSTR("\e*1V"));
    */

    for (;;) {
        char c = c_getchar_block();
        if (c == '\r') {
            c_putchar('\n');
            c_putchar('\r');
        } else {
            c_putchar(c);
        }
    }
}
